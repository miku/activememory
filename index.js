// Mostly showing and hiding controls, and attaching event handlers.
//
// 2019, May 07, martin.czygan@gmail.com
// 2019, May 12, do not pollute global namespace, use compact function notation
(function() {
    // Assumed elements of page:
    // check: A div containing the textarea for user input.
    // card: A div for the words to recall.
    // userinput: The textarea for user input.
    document.addEventListener('DOMContentLoaded', _ => {
        const $ = document.getElementById.bind(document);

        $('check').hidden = true;
        $('card').hidden = false;

        const words = sample(wordlist, 20);
        const delay = 600;
        const homepage = 'https://miku.github.io/activememory';

        $('checkBtn').addEventListener('click', _ => {
            const hits = intersection(words, $('userinput').value.match(/[^\s]+/g));
            $('card').hidden = false;
            $('card').innerHTML =
                hits.length + ' ouf of ' + words.length +
                ' recalled correctly &mdash; <a href="' + homepage + '">restart<a>.';
            $('checkBtn').hidden = true;
        });

        $('startBtn').addEventListener('click', _ => {
            $('startBtn').disabled = true;
            $('startBtn').innerHTML = 'Running';
            sequence($('card'), words, delay, _ => {
                $('startBtn').hidden = true;
                $('card').hidden = true;
                $('check').hidden = false;
                $('userinput').value = '';
                $('userinput').focus();
            });
        });
    });

    // sequence flashes items (e.g. words or any HTML) in a given element with a
    // delay (in ms). A function donecb is called, when the sequence is done.
    const sequence = (elem, items, delay, donecb) => {
        if (!isElement(elem)) {
            throw 'not a node: ' + elem;
        }
        var items = items ? items : [];
        var delay = typeof delay === 'number' ? delay : 600;
        let i = 0;
        let step = function() {
            if (i < items.length) {
                elem.innerHTML = items[i];
                i += 1;
                setTimeout(step, delay);
            } else {
                if (typeof donecb === 'function') {
                    donecb();
                }
            }
        };
        setTimeout(step, delay);
    };

    // intersection return intersecting elements between two lists.
    const intersection = (a, b) => {
        var a = a ? a : [];
        var b = b ? b : [];
        let result = [];
        for (let i = 0; i < a.length; i++) {
            for (let j = 0; j < b.length; j++) {
                if (a[i].localeCompare(b[j], undefined, {
                        sensitivity: "base"
                    }) === 0) {
                    result.push(a[i]);
                    break;
                }
            }
        }
        return result;
    }

    // Return true, if obj is a DOM element.
    const isElement = (obj) => {
        try {
            // Using W3 DOM2 (works for FF, Opera and Chrome)..
            return obj instanceof HTMLElement;
        } catch (e) {
            // Browsers not supporting W3 DOM2 don't have HTMLElement and
            // an exception is thrown and we end up here. Testing some
            // properties that all elements have (works on IE7).
            return (
                typeof obj === 'object' &&
                obj.nodeType === 1 &&
                typeof obj.style === 'object' &&
                typeof obj.ownerDocument === 'object'
            );
        }
    }

    // sample returns a random sample of a given size from array, will fail, if
    // sample size is bigger than array.
    const sample = (array, size) => {
        var array = array ? array : [];
        var size = size ? size : 10;

        if (array.length < size) {
            throw 'array too short';
        }

        // Keep indices around, so we can have random numbers without repetition.
        var indices = [];
        for (i = 0; i < array.length; i++) {
            indices.push(i);
        }

        // Random sample indices.
        var si = [];
        for (i = 0; i < size; i++) {
            var j = Math.floor(Math.random() * (indices.length + 1));
            si.push(indices[j]);
            indices.splice(j, 1);
        }

        // Sample the given array.
        var result = [];
        for (i = 0; i < si.length; i++) {
            result.push(array[si[i]]);
        }
        return result;
    }

    const wordlist = [
        'ability',
        'able',
        'about',
        'above',
        'accept',
        'according',
        'account',
        'across',
        'act',
        'action',
        'activity',
        'actually',
        'add',
        'address',
        'administration',
        'admit',
        'adult',
        'affect',
        'after',
        'again',
        'against',
        'age',
        'agency',
        'agent',
        'ago',
        'agree',
        'agreement',
        'ahead',
        'air',
        'all',
        'allow',
        'almost',
        'alone',
        'along',
        'already',
        'also',
        'although',
        'always',
        'American',
        'among',
        'amount',
        'analysis',
        'and',
        'animal',
        'another',
        'answer',
        'any',
        'anyone',
        'anything',
        'appear',
        'apply',
        'approach',
        'area',
        'argue',
        'arm',
        'around',
        'arrive',
        'art',
        'article',
        'artist',
        'ask',
        'assume',
        'attack',
        'attention',
        'attorney',
        'audience',
        'author',
        'authority',
        'available',
        'avoid',
        'away',
        'baby',
        'back',
        'bad',
        'bag',
        'ball',
        'bank',
        'bar',
        'base',
        'beat',
        'beautiful',
        'because',
        'become',
        'bed',
        'before',
        'begin',
        'behavior',
        'behind',
        'believe',
        'benefit',
        'best',
        'better',
        'between',
        'beyond',
        'big',
        'bill',
        'billion',
        'bit',
        'black',
        'blood',
        'blue',
        'board',
        'body',
        'book',
        'born',
        'both',
        'box',
        'boy',
        'break',
        'bring',
        'brother',
        'budget',
        'build',
        'building',
        'business',
        'but',
        'buy',
        'call',
        'camera',
        'campaign',
        'can',
        'cancer',
        'candidate',
        'capital',
        'car',
        'card',
        'care',
        'career',
        'carry',
        'case',
        'catch',
        'cause',
        'cell',
        'center',
        'central',
        'century',
        'certain',
        'certainly',
        'chair',
        'challenge',
        'chance',
        'change',
        'character',
        'charge',
        'check',
        'child',
        'choice',
        'choose',
        'church',
        'citizen',
        'city',
        'civil',
        'claim',
        'class',
        'clear',
        'clearly',
        'close',
        'coach',
        'cold',
        'collection',
        'college',
        'color',
        'come',
        'commercial',
        'common',
        'community',
        'company',
        'compare',
        'computer',
        'concern',
        'condition',
        'conference',
        'Congress',
        'consider',
        'consumer',
        'contain',
        'continue',
        'control',
        'cost',
        'could',
        'country',
        'couple',
        'course',
        'court',
        'cover',
        'create',
        'crime',
        'cultural',
        'culture',
        'cup',
        'current',
        'customer',
        'cut',
        'dark',
        'data',
        'daughter',
        'day',
        'dead',
        'deal',
        'death',
        'debate',
        'decade',
        'decide',
        'decision',
        'deep',
        'defense',
        'degree',
        'Democrat',
        'democratic',
        'describe',
        'design',
        'despite',
        'detail',
        'determine',
        'develop',
        'development',
        'die',
        'difference',
        'different',
        'difficult',
        'dinner',
        'direction',
        'director',
        'discover',
        'discuss',
        'discussion',
        'disease',
        'doctor',
        'dog',
        'door',
        'down',
        'draw',
        'dream',
        'drive',
        'drop',
        'drug',
        'during',
        'each',
        'early',
        'east',
        'easy',
        'eat',
        'economic',
        'economy',
        'edge',
        'education',
        'effect',
        'effort',
        'eight',
        'either',
        'election',
        'else',
        'employee',
        'end',
        'energy',
        'enjoy',
        'enough',
        'enter',
        'entire',
        'environment',
        'environmental',
        'especially',
        'establish',
        'even',
        'evening',
        'event',
        'ever',
        'every',
        'everybody',
        'everyone',
        'everything',
        'evidence',
        'exactly',
        'example',
        'executive',
        'exist',
        'expect',
        'experience',
        'expert',
        'explain',
        'eye',
        'face',
        'fact',
        'factor',
        'fail',
        'fall',
        'family',
        'far',
        'fast',
        'father',
        'fear',
        'federal',
        'feel',
        'feeling',
        'few',
        'field',
        'fight',
        'figure',
        'fill',
        'film',
        'final',
        'finally',
        'financial',
        'find',
        'fine',
        'finger',
        'finish',
        'fire',
        'firm',
        'first',
        'fish',
        'five',
        'floor',
        'fly',
        'focus',
        'follow',
        'food',
        'foot',
        'for',
        'force',
        'foreign',
        'forget',
        'form',
        'former',
        'forward',
        'four',
        'free',
        'friend',
        'from',
        'front',
        'full',
        'fund',
        'future',
        'game',
        'garden',
        'gas',
        'general',
        'generation',
        'get',
        'girl',
        'give',
        'glass',
        'goal',
        'good',
        'government',
        'great',
        'green',
        'ground',
        'group',
        'grow',
        'growth',
        'guess',
        'gun',
        'guy',
        'hair',
        'half',
        'hand',
        'hang',
        'happen',
        'happy',
        'hard',
        'have',
        'head',
        'health',
        'hear',
        'heart',
        'heat',
        'heavy',
        'help',
        'her',
        'here',
        'herself',
        'high',
        'him',
        'himself',
        'his',
        'history',
        'hit',
        'hold',
        'home',
        'hope',
        'hospital',
        'hot',
        'hotel',
        'hour',
        'house',
        'how',
        'however',
        'huge',
        'human',
        'hundred',
        'husband',
        'idea',
        'identify',
        'image',
        'imagine',
        'impact',
        'important',
        'improve',
        'include',
        'including',
        'increase',
        'indeed',
        'indicate',
        'individual',
        'industry',
        'information',
        'inside',
        'instead',
        'institution',
        'interest',
        'interesting',
        'international',
        'interview',
        'into',
        'investment',
        'involve',
        'issue',
        'item',
        'its',
        'itself',
        'job',
        'join',
        'just',
        'keep',
        'key',
        'kid',
        'kill',
        'kind',
        'kitchen',
        'know',
        'knowledge',
        'land',
        'language',
        'large',
        'last',
        'late',
        'later',
        'laugh',
        'law',
        'lawyer',
        'lay',
        'lead',
        'leader',
        'learn',
        'least',
        'leave',
        'left',
        'leg',
        'legal',
        'less',
        'let',
        'letter',
        'level',
        'lie',
        'life',
        'light',
        'like',
        'likely',
        'line',
        'list',
        'listen',
        'little',
        'live',
        'local',
        'long',
        'look',
        'lose',
        'loss',
        'lot',
        'love',
        'low',
        'machine',
        'magazine',
        'main',
        'maintain',
        'major',
        'majority',
        'make',
        'man',
        'manage',
        'management',
        'manager',
        'many',
        'market',
        'marriage',
        'material',
        'matter',
        'may',
        'maybe',
        'mean',
        'measure',
        'media',
        'medical',
        'meet',
        'meeting',
        'member',
        'memory',
        'mention',
        'message',
        'method',
        'middle',
        'might',
        'military',
        'million',
        'mind',
        'minute',
        'miss',
        'mission',
        'model',
        'modern',
        'moment',
        'money',
        'month',
        'more',
        'morning',
        'most',
        'mother',
        'mouth',
        'move',
        'movement',
        'movie',
        'Mrs',
        'much',
        'music',
        'must',
        'myself',
        'name',
        'nation',
        'national',
        'natural',
        'nature',
        'near',
        'nearly',
        'necessary',
        'need',
        'network',
        'never',
        'new',
        'news',
        'newspaper',
        'next',
        'nice',
        'night',
        'none',
        'nor',
        'north',
        'not',
        'note',
        'nothing',
        'notice',
        'now',
        'number',
        'occur',
        'off',
        'offer',
        'office',
        'officer',
        'official',
        'often',
        'oil',
        'old',
        'once',
        'one',
        'only',
        'onto',
        'open',
        'operation',
        'opportunity',
        'option',
        'order',
        'organization',
        'other',
        'others',
        'our',
        'out',
        'outside',
        'over',
        'own',
        'owner',
        'page',
        'pain',
        'painting',
        'paper',
        'parent',
        'part',
        'participant',
        'particular',
        'particularly',
        'partner',
        'party',
        'pass',
        'past',
        'patient',
        'pattern',
        'pay',
        'peace',
        'people',
        'per',
        'perform',
        'performance',
        'perhaps',
        'period',
        'person',
        'personal',
        'phone',
        'physical',
        'pick',
        'picture',
        'piece',
        'place',
        'plan',
        'plant',
        'play',
        'player',
        'point',
        'police',
        'policy',
        'political',
        'politics',
        'poor',
        'popular',
        'population',
        'position',
        'positive',
        'possible',
        'power',
        'practice',
        'prepare',
        'present',
        'president',
        'pressure',
        'pretty',
        'prevent',
        'price',
        'private',
        'probably',
        'problem',
        'process',
        'produce',
        'product',
        'production',
        'professional',
        'professor',
        'program',
        'project',
        'property',
        'protect',
        'prove',
        'provide',
        'public',
        'pull',
        'purpose',
        'push',
        'put',
        'quality',
        'question',
        'quickly',
        'quite',
        'race',
        'radio',
        'raise',
        'range',
        'rate',
        'rather',
        'reach',
        'read',
        'ready',
        'real',
        'reality',
        'realize',
        'really',
        'reason',
        'receive',
        'recent',
        'recently',
        'recognize',
        'record',
        'red',
        'reduce',
        'reflect',
        'region',
        'relate',
        'relationship',
        'religious',
        'remain',
        'remember',
        'remove',
        'report',
        'represent',
        'Republican',
        'require',
        'research',
        'resource',
        'respond',
        'response',
        'responsibility',
        'rest',
        'result',
        'return',
        'reveal',
        'rich',
        'right',
        'rise',
        'risk',
        'road',
        'rock',
        'role',
        'room',
        'rule',
        'run',
        'safe',
        'same',
        'save',
        'say',
        'scene',
        'school',
        'science',
        'scientist',
        'score',
        'sea',
        'season',
        'seat',
        'second',
        'section',
        'security',
        'see',
        'seek',
        'seem',
        'sell',
        'send',
        'senior',
        'sense',
        'series',
        'serious',
        'serve',
        'service',
        'set',
        'seven',
        'several',
        'sex',
        'sexual',
        'shake',
        'share',
        'she',
        'shoot',
        'short',
        'shot',
        'should',
        'shoulder',
        'show',
        'side',
        'sign',
        'significant',
        'similar',
        'simple',
        'simply',
        'since',
        'sing',
        'single',
        'sister',
        'sit',
        'site',
        'situation',
        'six',
        'size',
        'skill',
        'skin',
        'small',
        'smile',
        'social',
        'society',
        'soldier',
        'some',
        'somebody',
        'someone',
        'something',
        'sometimes',
        'son',
        'song',
        'soon',
        'sort',
        'sound',
        'source',
        'south',
        'southern',
        'space',
        'speak',
        'special',
        'specific',
        'speech',
        'spend',
        'sport',
        'spring',
        'staff',
        'stage',
        'stand',
        'standard',
        'star',
        'start',
        'state',
        'statement',
        'station',
        'stay',
        'step',
        'still',
        'stock',
        'stop',
        'store',
        'story',
        'strategy',
        'street',
        'strong',
        'structure',
        'student',
        'study',
        'stuff',
        'style',
        'subject',
        'success',
        'successful',
        'such',
        'suddenly',
        'suffer',
        'suggest',
        'summer',
        'support',
        'sure',
        'surface',
        'system',
        'table',
        'take',
        'talk',
        'task',
        'tax',
        'teach',
        'teacher',
        'team',
        'technology',
        'television',
        'tell',
        'ten',
        'tend',
        'term',
        'test',
        'than',
        'thank',
        'that',
        'the',
        'their',
        'them',
        'themselves',
        'then',
        'theory',
        'there',
        'these',
        'they',
        'thing',
        'think',
        'third',
        'this',
        'those',
        'though',
        'thought',
        'thousand',
        'threat',
        'three',
        'through',
        'throughout',
        'throw',
        'thus',
        'time',
        'today',
        'together',
        'tonight',
        'too',
        'top',
        'total',
        'tough',
        'toward',
        'town',
        'trade',
        'traditional',
        'training',
        'travel',
        'treat',
        'treatment',
        'tree',
        'trial',
        'trip',
        'trouble',
        'true',
        'truth',
        'try',
        'turn',
        'two',
        'type',
        'under',
        'understand',
        'unit',
        'until',
        'upon',
        'use',
        'usually',
        'value',
        'various',
        'very',
        'victim',
        'view',
        'violence',
        'visit',
        'voice',
        'vote',
        'wait',
        'walk',
        'wall',
        'want',
        'war',
        'watch',
        'water',
        'way',
        'weapon',
        'wear',
        'week',
        'weight',
        'well',
        'west',
        'western',
        'what',
        'whatever',
        'when',
        'where',
        'whether',
        'which',
        'while',
        'white',
        'who',
        'whole',
        'whom',
        'whose',
        'why',
        'wide',
        'wife',
        'will',
        'win',
        'wind',
        'window',
        'wish',
        'with',
        'within',
        'without',
        'woman',
        'wonder',
        'word',
        'work',
        'worker',
        'world',
        'worry',
        'would',
        'write',
        'writer',
        'wrong',
        'yard',
        'yeah',
        'year',
        'yes',
        'yet',
        'you',
        'young',
        'your',
        'yourself'
    ];
})();
